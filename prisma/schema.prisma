generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
enum Enrollment_type{
  online
  hybrid
}
enum enrollment_access_type{
  active
  inactive
}
enum Otp_type{
  none
  registration
  reset_password
  change_password
  forget_password
}
enum OrderStatus {
  pending
  confirmed
  cancelled
  failed
}
enum Enrollment_status{
  pending
  failed 
  success
  cancelled
}
enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  BKASH
  NAGAD
  STRIPE
  SSL_COMMERZ
  CASH
  OTHER
  BANK
}

enum announcement_status{
  active
  expired
  draft
  scheduled
}

enum Promocode_for{
  all
  book
  course
}
model User { 
  id Int @id @default(autoincrement())
  user_id String @unique
  name      String   @default(".........")
  phone     String   @unique
  password  String  // hashed
  is_verified Boolean @default(false)
  is_blocked Boolean  @default(false)
  enrollments Enrollment[]
  roles Role[]
  payments Payment[]
  book_orders Book_order[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model Course{
  id Int @id @default(autoincrement())
  course_id String @unique
  batch String @default("_")
  course_title String
  chapters Chapter[] 
  slug String @unique
  price Float @default(0)
  is_deleted Boolean @default(false)
  is_featured Boolean @default(false)
  thumbnail String @default("localhost://schema.com")
  course_details Course_details?
  createdAt DateTime @default(now())
  related_books  Book[]   @relation("CourseBooks")  // link books
  enrollments Enrollment[]
  exams Exam[]
  announcements Announcement[]
  live_classes Live_class[]
  promo_codes Promo_code[]
  updatedAt DateTime @updatedAt
}
model Course_details{
  id Int @id @default(autoincrement())
  course_id String @unique
  slug String @unique
  course_details_id String  @unique
  academy_name String 
  published_date DateTime
  language String
  // description String @db.LongText()
  description String 
  related_book String  @default("") // it will be id
  quiz_count Int @default(0)
  assessment Boolean  @default(false)
  skill_level String
  expired_date DateTime
  course Course @relation(fields: [course_id],references: [course_id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Chapter{
    id Int @id @default(autoincrement())
    chapter_id String @unique
    course_id String 
    title String
    course Course @relation(fields: [course_id],references: [course_id])
    topics Chapter_topic[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Chapter_topic{
  id Int @id @default(autoincrement())
  chapter_topic_id String @unique
  chapter_id String
  title String 
  slug String @unique
  youtube_url String
  chapters Chapter? @relation(fields: [chapter_id],references: [chapter_id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model Book{
  id Int @id @default(autoincrement())
  book_id String @unique
  slug String @unique
  stock Int @default(0)
  batch String @default("HSC")
  book_image String
  title String
  price Float
  writter String
  demo_file_link String? @default("")
  // description String @db.LongText()
  description String 
  is_deleted Boolean @default(false)
  is_featured Boolean  @default(false)
  orders Book_order[]
  courses   Course[] @relation("CourseBooks")  // many-to-many relation
  promo_codes Promo_code[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model Book_order{ 
  id Int @id @default(autoincrement())
  order_id String @unique
  book_id String
  user_id String?
  product_price Float
  alternative_phone String?
  wp_number String?
  fb_name String?
  quantity Int @default(1)
  address String
  Txn_ID String @unique
  status OrderStatus @default(pending)
  book Book? @relation(fields: [book_id],references: [book_id])
  confirmed Boolean @default(false)
  payment Payment?
  user          User?    @relation(fields: [user_id], references: [user_id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Note{ 
  id Int @id @default(autoincrement())
  note_id String @unique
  slug String @unique
  note_name String
  note_desc String 
  note_file_link String
  shared_by String // author name
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}




model Enrollment { // ony for course
  id Int @id @default(autoincrement())
  enrollment_id String @unique
  enrollment_type Enrollment_type @default(online) // hybrid
  user_id String
  wp_number String?
  fb_name String?
  course_id String
  address String?
  expiry_date DateTime
  is_blocked Boolean @default(false)
  status enrollment_access_type  @default(active)
  enrollment_status Enrollment_status @default(pending) 
  active_inactive_reason String? // example: due payment
  user User @relation(fields: [user_id],references: [user_id])
  course Course? @relation(fields: [course_id],references: [course_id])
  
    // Optional Payment relation
  payment Payment?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model Exam{
  id Int @id @default(autoincrement())
  exam_id String @unique
  course_id String
  exam_title String
  exam_start_time DateTime
  exam_end_time DateTime
  exam_topic String
  exam_description String
  exam_link String
  course Course? @relation(fields: [course_id],references: [course_id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Announcement{
  id Int @id @default(autoincrement())
  announcement_id String @unique
  title String
  description String?
  course_id String
  course Course? @relation(fields: [course_id],references: [course_id])
  attachment_url String?
  status announcement_status
  start_date DateTime
  end_date DateTime
  is_send_sms Boolean?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model Payment { 
  id Int @id @default(autoincrement())
  payment_id String @unique
  val_id String? @unique 
  // Relation to User
  user_id          String
  user            User     @relation(fields: [user_id], references: [user_id])
  // Payment Details
  meterial_price Float
  product_price_with_quantity Float
  discount_amount  Float?         // ছাড়ের পরিমাণ
  // amount          Float
  paid_amount     Float
  due_amount      Float
  willCustomerGetAmount Boolean @default(false)
  customer_receivable_amount Float @default(0)
  delevery_charge Float @default(0)
  advance_charge_amount Float @default(0)
  tran_date String?
  card_type String?
  card_issuer String?
  store_amount String?
  card_category String?
  currency        String   @default("BDT")
  status          PaymentStatus @default(PENDING)
  method          PaymentMethod @default(SSL_COMMERZ)
  Txn_ID   String?  @unique
  paymentGateway  PaymentMethod  @default(SSL_COMMERZ)
    // Promo info (optional)
  promo_code_id    String? 
  promo_code      Promo_code?    

  // Metadata
  purpose         String   // e.g. "Course purchase", "Subscription", "Book order"
  book_order_id     String?  @unique //  order_id or enrollment_id etc.
  enrollment_id     String?  @unique //  order_id or enrollment_id etc.
  remarks         String?  // optional note
  course_enrollment Enrollment? @relation(fields: [enrollment_id],references: [enrollment_id])
  book_order Book_order? @relation(fields: [book_order_id],references: [order_id])
  
  @@index([status])
  @@index([book_order_id])
  @@index([enrollment_id])
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}


model Promo_code{
  id Int @id @default(autoincrement())
  promo_code_id String @unique
  promocode_for Promocode_for @default(all)// BOOK / COURSE / ALL
  promo_code String @unique
  Discount_type String // fixed or percentage
  Discount Int //percentage/fixed taka defined from discount type field
  Max_discount_amount Int
  Min_purchase_amount Int
  expiry_date DateTime
  status String
  book_id String?
  course_id String?
   // relation
  book   Book?   @relation(fields: [book_id], references: [book_id])
  course Course? @relation(fields: [course_id], references: [course_id])
  is_deleted Boolean @default(false)
  payment  Payment?    @relation(fields: [payment_id], references: [payment_id])
  payment_id          String?     @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model Otp{
  id Int @id @default(autoincrement())
  otp_id String @unique
  otp String // hashed
  otp_type Otp_type @default(none)
  phone String
  expiry_date DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model Role {
  id Int @id @default(autoincrement())
  role_id String @unique
  user_id String
  phone String
  role String @default("student")
  role_code Int @default(200) // 100 admin, 200 user
  user User @relation(fields: [phone],references: [phone])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}



model Live_class{
  id Int @id @default(autoincrement())
  live_class_id String @unique
  title String
  description String
  teacher_name String
  start_time DateTime
  end_time DateTime
  is_deleted Boolean @default(false)
  meeting_id String
  meeting_password  String
  join_url String
  course_id String
  
  course Course? @relation(fields: [course_id],references: [course_id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
